<#
.SYNOPSIS
    This adds a specified domain or email address to a user's safe sender list. 
.NOTES
    Author: Josh Block
    Date: 01.17.23
    Type: Public
    Version: 1.0.0
.LINK
    https://github.com/j0shbl0ck
    https://learn.microsoft.com/en-us/powershell/module/exchange/set-mailboxjunkemailconfiguration?view=exchange-ps
    https://o365info.com/manage-safe-senders-block-sender-lists-using-powershell-office-365/
#>


Clear-Host

# Connect to Exchange Online via Entra Id
Function Connect_Exo{
    try {
        Write-Host -ForegroundColor Yellow 'Connecting to Exchange Online...'
        
        # Connect to Exchange Online
        Connect-ExchangeOnline | Clear-Host
        
        Write-Host -ForegroundColor Green 'Connected to Exchange Online.'
        Write-Host ""
    }
    catch {
        Write-Host "Failed to connect to Exchange Online. Ending script." -ForegroundColor Red
        exit
    }   
}

# Connect to Microsoft Graph via Entra Id
Function Connect_Msg {
    try {
        Write-Host -ForegroundColor Yellow 'Connecting to Microsoft Graph...'

        # Connecto Microsoft Graph
        Connect-Graph -Scopes User.ReadWrite.All | Clear Host

        Write-Host -ForegroundColor Green 'Connected to Microsoft Graph'
        Write-Host ""

    }
    catch {
        Write-Host "Failed to connect to Microsoft Graph. Ending script." -ForegroundColor Red 
        exit
    }
}


Connect_Msg
Connect_Exo

# Get all shared mailboxes in Exchange Online
Get-Mailbox -ResultSize Unlimited -RecipientTypeDetails SharedMailbox | foreach {
    $userAccount=$_.UserPrincipalName
    $PrimarySMTPAddress=$_.PrimarySMTPAddress
    $Name=$_.Name
    # Block all shared mailbox sign-in capabilities
    $params = @{
	    accountEnabled = $false
    }
    Update-MgUser -UserId $userAccount -BodyParameter $params

}





